<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      min-height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
    }

    .video-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .video-container {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 24px;
      border: 1px solid #2a2a2a;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .video-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      height: 300px;
    }

    .video-wrapper {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      border: 1px solid #2a2a2a;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #localVideo {
      transform: scaleX(-1);
    }

    .video-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 500;
    }

    .chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .chat-container {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 24px;
      border: 1px solid #2a2a2a;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #2a2a2a;
    }

    .ai-avatar {
      width: 44px;
      height: 44px;
      background: #2a2a2a;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      border: 1px solid #3a3a3a;
    }

    .ai-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #ffffff;
    }

    .ai-status {
      font-size: 12px;
      color: #888888;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: #4ade80;
      border-radius: 50%;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
      scroll-behavior: smooth;
    }

    .message {
      margin: 15px 0;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      border: 1px solid #3a3a3a;
    }

    .message.user .message-avatar {
      background: #2a2a2a;
    }

    .message.bot .message-avatar {
      background: #2a2a2a;
    }

    .message-content {
      max-width: 70%;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: #2a2a2a;
      color: #ffffff;
      border: 1px solid #3a3a3a;
    }

    .message.bot .message-content {
      background: #1a1a1a;
      color: #ffffff;
      border: 1px solid #2a2a2a;
    }

    .message-time {
      font-size: 11px;
      color: #666666;
      margin-top: 6px;
    }

    .chat-input-container {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #2a2a2a;
    }

    .chat-input {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 14px 18px;
      color: #ffffff;
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }

    .chat-input:focus {
      border-color: #3a3a3a;
    }

    .chat-input::placeholder {
      color: #666666;
    }

    .send-button {
      width: 48px;
      height: 48px;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 12px;
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .send-button:hover {
      background: #3a3a3a;
      border-color: #4a4a4a;
    }

    .send-button:active {
      background: #1a1a1a;
    }

    .voice-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      transition: all 0.2s ease;
      max-width: 300px;
    }

    .voice-indicator.listening {
      background: #1a2a1a;
      border-color: #2a4a2a;
      color: #4ade80;
    }

    .voice-indicator.error {
      background: #2a1a1a;
      border-color: #4a2a2a;
      color: #f87171;
    }

    .voice-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666666;
      flex-shrink: 0;
    }

    .voice-indicator.listening .voice-dot {
      background: #4ade80;
    }

    .voice-indicator.error .voice-dot {
      background: #f87171;
    }

    .transcription-text {
      color: #888888;
      font-style: italic;
      margin-left: 8px;
      word-break: break-word;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      opacity: 0.7;
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #667eea;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .messages::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    .messages::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .welcome-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0a0a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }

    .welcome-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .welcome-content {
      text-align: center;
      max-width: 500px;
      padding: 40px;
      background: #1a1a1a;
      border-radius: 16px;
      border: 1px solid #2a2a2a;
    }

    .welcome-title {
      font-size: 36px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #ffffff;
    }

    .welcome-subtitle {
      font-size: 16px;
      color: #888888;
      margin-bottom: 32px;
      line-height: 1.5;
    }

    .connect-button {
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 12px;
      padding: 16px 32px;
      color: #ffffff;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .connect-button:hover {
      background: #3a3a3a;
      border-color: #4a4a4a;
    }

    .connect-button:active {
      background: #1a1a1a;
    }

    .connect-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
  <div id="welcomeScreen" class="welcome-screen">
    <div class="welcome-content">
      <h1 class="welcome-title">–ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB</h1>
      <p class="welcome-subtitle">
        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ! –Ø –±–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB.<br>
        –ú—ã –ø—Ä–æ–≤–µ–¥–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å—Ö–µ–º–µ.
      </p>
      <button id="connectButton" class="connect-button">
        –ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
      </button>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
  <div id="mainInterface" class="container" style="display: none;">
    <!-- –°–µ–∫—Ü–∏—è –≤–∏–¥–µ–æ -->
    <div class="video-section">
      <div class="video-container">
        <div class="video-grid">
          <div class="video-wrapper">
            <video id="localVideo" autoplay muted></video>
            <div class="video-label">–í—ã</div>
          </div>
          <div class="video-wrapper">
            <video id="remoteVideo" autoplay></video>
            <div class="video-label">–ò–ò-–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
          </div>
        </div>
      </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —á–∞—Ç–∞ -->
    <div class="chat-section">
      <div class="chat-container">
        <div class="chat-header">
          <div class="ai-avatar">ü§ñ</div>
          <div class="ai-info">
            <h3>–ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB</h3>
            <div class="ai-status">
              <div class="status-dot"></div>
              <span>–ì–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ—Ä–≤—å—é</span>
            </div>
          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="chat-input-container">
          <input 
            id="chatInput" 
            class="chat-input" 
            type="text" 
            placeholder="–û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏–Ω—Ç–µ—Ä–≤—å—é –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç–µ –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω..."
            autocomplete="off"
          >
          <button id="sendButton" class="send-button">‚û§</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥–æ–ª–æ—Å–∞ -->
  <div id="voiceIndicator" class="voice-indicator" style="display: none;">
    <div class="voice-dot"></div>
    <span id="voiceStatus">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω</span>
    <span id="transcriptionText" class="transcription-text"></span>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let ws = null;
    let localStream = null;
    let roomId = null;
    let isConnected = false;
    let isTTSEnabled = true;
    let currentUtterance = null;
    let recognition = null;
    let silenceTimer = null;
    let isListening = false;

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const welcomeScreen = document.getElementById('welcomeScreen');
    const mainInterface = document.getElementById('mainInterface');
    const connectButton = document.getElementById('connectButton');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const messages = document.getElementById('messages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const voiceIndicator = document.getElementById('voiceIndicator');
    const voiceStatus = document.getElementById('voiceStatus');
    const transcriptionText = document.getElementById('transcriptionText');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏–∑ URL
      const urlParams = new URLSearchParams(window.location.search);
      const candidateInfo = {
        resume_id: urlParams.get('resume_id'),
        vacancy_id: urlParams.get('vacancy_id'),
        candidate: urlParams.get('candidate'),
        score: urlParams.get('score')
      };
      
      console.log('üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–¥–∏–¥–∞—Ç–µ:', candidateInfo);
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é
      if (candidateInfo.resume_id || candidateInfo.candidate) {
        console.log('üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–≤—å—é...');
        await startInterviewMode(candidateInfo);
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        welcomeScreen.style.display = 'flex';
        mainInterface.style.display = 'none';
      }
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      setupEventListeners();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏
      initSpeechRecognition();
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
      connectButton.onclick = handleConnect;
      sendButton.onclick = sendMessage;
      chatInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      };
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–≤—å—é
    async function startInterviewMode(candidateInfo) {
      try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞
        await ensureMedia();
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É
        roomId = generateRoomId();
        console.log(`üè† –°–æ–∑–¥–∞–Ω–∞ –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é: ${roomId}`);
        
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
        connectWS();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞
        await startInterviewBot(candidateInfo);
        
        // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        setTimeout(() => {
          welcomeScreen.classList.add('hidden');
          mainInterface.style.display = 'flex';
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é
          document.querySelector('.ai-info h3').textContent = '–ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB';
          document.querySelector('.video-label').textContent = '–ö–∞–Ω–¥–∏–¥–∞—Ç';
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        welcomeScreen.style.display = 'flex';
        mainInterface.style.display = 'none';
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    async function handleConnect() {
      connectButton.disabled = true;
      connectButton.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
      
      try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞
        await ensureMedia();
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É
        roomId = generateRoomId();
        console.log(`üè† –°–æ–∑–¥–∞–Ω–∞ –∫–æ–º–Ω–∞—Ç–∞: ${roomId}`);
        
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
        connectWS();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ò–ò-–±–æ—Ç–∞
        await startAIBot();
        
        // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        setTimeout(() => {
          welcomeScreen.classList.add('hidden');
          mainInterface.style.display = 'flex';
          
          // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          addMessage('bot', '–ü—Ä–∏–≤–µ—Ç! –†–∞–¥ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è! üòä –ö–∞–∫ –¥–µ–ª–∞?');
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
        connectButton.disabled = false;
        connectButton.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
      }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∫–æ–º–Ω–∞—Ç—ã
    function generateRoomId() {
      return Math.random().toString(36).slice(2, 9);
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞
    async function ensureMedia() {
      if (!localStream) {
        localStream = await navigator.mediaDevices.getUserMedia({ 
          video: true, 
          audio: true 
        });
        localVideo.srcObject = localStream;
        console.log('üìπ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω');
      }
    }

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
    function connectWS() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);
      
      ws.onopen = () => {
        console.log('üîå WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        isConnected = true;
        
        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
        ws.send(JSON.stringify({
          type: 'join',
          room: roomId,
          name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
        }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      };

      ws.onclose = () => {
        console.log('üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
        isConnected = false;
      };

      ws.onerror = (error) => {
        console.error('‚ùå –û—à–∏–±–∫–∞ WebSocket:', error);
      };
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
    function handleWebSocketMessage(data) {
      console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
      
      switch (data.type) {
        case 'waiting':
          console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
          break;
          
        case 'initiate':
          console.log('üöÄ –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
          break;
          
        case 'peer-joined':
          console.log('üë§ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è');
          break;
          
        case 'chat':
          if (data.bot) {
            addMessage('bot', data.text);
            if (isTTSEnabled) {
              speakText(data.text);
            }
          }
          break;
          
        case 'offer':
        case 'answer':
        case 'candidate':
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ WebRTC —Å–∏–≥–Ω–∞–ª–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞)
          break;
      }
    }

    // –ó–∞–ø—É—Å–∫ –ò–ò-–±–æ—Ç–∞
    async function startAIBot() {
      try {
        const response = await fetch('/start-ai-bot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roomId })
        });
        
        const data = await response.json();
        console.log('ü§ñ –ò–ò-–±–æ—Ç –∑–∞–ø—É—â–µ–Ω:', data);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ò–ò-–±–æ—Ç–∞:', error);
      }
    }

    // –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞
    async function startInterviewBot(candidateInfo) {
      try {
        const response = await fetch('/start-interview-bot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            roomId: roomId,
            candidateInfo: candidateInfo
          })
        });
        
        const data = await response.json();
        console.log('üéØ –ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä –∑–∞–ø—É—â–µ–Ω:', data);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞:', error);
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text || !isConnected) return;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
      addMessage('user', text);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
      ws.send(JSON.stringify({
        type: 'chat',
        text: text,
        name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
      }));
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      chatInput.value = '';
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    function addMessage(sender, text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
      
      const content = document.createElement('div');
      content.className = 'message-content';
      content.textContent = text;
      
      const time = document.createElement('div');
      time.className = 'message-time';
      time.textContent = new Date().toLocaleTimeString();
      
      content.appendChild(time);
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);
      
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        console.warn('‚ö†Ô∏è –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        return;
      }

      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'ru-RU';

      recognition.onstart = () => {
        console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∑–∞–ø—É—â–µ–Ω–æ');
        isListening = true;
        showVoiceIndicator('listening', '–°–ª—É—à–∞—é...');
      };

      recognition.onresult = (event) => {
        let finalTranscript = '';
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
        if (interimTranscript) {
          transcriptionText.textContent = interimTranscript;
          showVoiceIndicator('listening', '–°–ª—É—à–∞—é...');
        }

        if (finalTranscript) {
          console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:', finalTranscript);
          chatInput.value = finalTranscript;
          transcriptionText.textContent = finalTranscript;
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
          clearTimeout(silenceTimer);
          silenceTimer = setTimeout(() => {
            if (chatInput.value.trim()) {
              sendMessage();
              transcriptionText.textContent = '';
            }
          }, 2000);
        }
      };

      recognition.onerror = (event) => {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏:', event.error);
        showVoiceIndicator('error', '–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
        isListening = false;
      };

      recognition.onend = () => {
        console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        isListening = false;
        transcriptionText.textContent = '';
        showVoiceIndicator('', '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏
        if (!recognition.error) {
          setTimeout(() => {
            if (isConnected) {
              recognition.start();
            }
          }, 100);
        }
      };

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
      setTimeout(() => {
        if (isConnected) {
          recognition.start();
        }
      }, 2000);
    }

    // –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≥–æ–ª–æ—Å–∞
    function showVoiceIndicator(type, text) {
      voiceIndicator.className = `voice-indicator ${type}`;
      voiceStatus.textContent = text;
      voiceIndicator.style.display = 'flex';
      
      if (type === '') {
        setTimeout(() => {
          voiceIndicator.style.display = 'none';
        }, 1000);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ —á–µ—Ä–µ–∑ Cartesia TTS
    async function speakText(text) {
      console.log('üîä –û–∑–≤—É—á–∏–≤–∞–µ–º:', text);
      
      try {
        const response = await fetch('/synthesize-speech', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text, language: 'ru' })
        });
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.success && data.audio) {
            const audio = new Audio(`data:audio/mp3;base64,${data.audio}`);
            await audio.play();
            console.log('‚úÖ –û–∑–≤—É—á–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
          }
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∫–∏:', error);
      }
    }
  </script>
</body>
</html>