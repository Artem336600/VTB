// interview-bot.js - –ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤—å—é
const { v4: uuidv4 } = require('uuid');

class InterviewBot {
  constructor() {
    this.serverUrl = (process.env.NODE_ENV === 'production' ? 'wss:' : 'ws:') + '//localhost:3000';
    this.ws = null;
    this.roomId = null;
    this.botId = uuidv4();
    this.isConnected = false;
    this.botName = '–ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB';
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ DeepSeek API
    this.apiKey = "sk-7446c16774044136aa33ab1b74eb1b31";
    this.baseUrl = "https://api.deepseek.com";
    this.model = "deepseek-chat";
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤—å—é
    this.interviewState = 'waiting'; // waiting, part1, part2, part3, part4, completed
    this.currentPart = 0;
    this.interviewResponses = {};
    this.candidateInfo = {};
    
    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ö–µ–º–∞ –∏–Ω—Ç–µ—Ä–≤—å—é VTB
    this.interviewStructure = {
      part1: {
        title: "ü§ù –ß–∞—Å—Ç—å 1: –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è —Ä–∞–∑–º–∏–Ω–∫–∞",
        duration: "5-10 –º–∏–Ω—É—Ç",
        questions: [
          {
            text: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø –±–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB. –°–µ–≥–æ–¥–Ω—è –º—ã –ø—Ä–æ–≤–µ–¥–µ–º —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 3 —á–∞—Å—Ç–µ–π:\n\n‚Ä¢ –°–æ—Ñ—Ç —Å–∫–∏–ª–ª—ã - –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –æ–ø—ã—Ç–∞ —Ä–∞–±–æ—Ç—ã –∏ —Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤\n‚Ä¢ –•–∞—Ä–¥ —Å–∫–∏–ª–ª—ã - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å\n‚Ä¢ –î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –æ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —à–∞–≥–∞—Ö\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ –æ –≤–∞—à–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø—Ä–æ–µ–∫—Ç–µ. –ß—Ç–æ —ç—Ç–æ –±—ã–ª –∑–∞ –ø—Ä–æ–µ–∫—Ç, –∫–∞–∫—É—é —Ä–æ–ª—å –≤—ã –≤—ã–ø–æ–ª–Ω—è–ª–∏, –∏ –∫–∞–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ—Å—Ç–∏–≥–ª–∏?",
            type: "warmup"
          }
        ]
      },
      part2: {
        title: "üí¨ –ß–∞—Å—Ç—å 2: –°–æ—Ñ—Ç —Å–∫–∏–ª–ª—ã",
        duration: "15-20 –º–∏–Ω—É—Ç",
        questions: [
          {
            text: "–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –≤–∞–º –ø—Ä–∏—à–ª–æ—Å—å –±—ã—Å—Ç—Ä–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –Ω–æ–≤—ã–º —É—Å–ª–æ–≤–∏—è–º —Ä–∞–±–æ—Ç—ã.\n\n–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–ª–∞–¥—à–∏–π —É—Ä–æ–≤–µ–Ω—å)",
            type: "adaptability"
          },
          {
            text: "–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ —É –≤–∞—Å –±—ã–ª–æ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–µ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º. –ö–∞–∫ –≤—ã –µ–≥–æ —Ä–µ—à–∏–ª–∏?\n\n–†–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤",
            type: "conflict_resolution"
          },
          {
            text: "–ö–∞–∫ –≤—ã –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ —Å–ª–æ–∂–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –ø—Ä–æ–µ–∫—Ç–∞?\n\n–ú–æ—Ç–∏–≤–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã",
            type: "team_motivation"
          }
        ]
      },
      part3: {
        title: "‚öôÔ∏è –ß–∞—Å—Ç—å 3: –•–∞—Ä–¥ —Å–∫–∏–ª–ª—ã",
        duration: "20-25 –º–∏–Ω—É—Ç",
        questions: [
          {
            text: "–û—Ç–ª–∏—á–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏! –£ –≤–∞—Å –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã. –î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º –≤–∞—à–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:\n\n–û–ø–∏—à–∏—Ç–µ –≤–∞—à –ø–æ–¥—Ö–æ–¥ –∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.\n\n–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å)",
            type: "architecture"
          },
          {
            text: "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –ø–æ–¥—Ö–æ–¥–µ –∫ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á.\n\n–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
            type: "productivity"
          },
          {
            text: "–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –ª—É—á—à–µ –≤—Å–µ–≥–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–∞—à–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏.\n\n–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞–≤—ã–∫–æ–≤",
            type: "skills_demonstration"
          },
          {
            text: "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –æ–ø—ã—Ç —Å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Ç—Ä–∞–∂–µ–Ω—ã –≤ —Ä–µ–∑—é–º–µ, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏?\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
            type: "additional_technologies"
          }
        ]
      },
      part4: {
        title: "üìÖ –ß–∞—Å—Ç—å 4: –î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏",
        duration: "5-10 –º–∏–Ω—É—Ç",
        questions: [
          {
            text: "–ö–æ–≥–¥–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ä–∞–±–æ—Ç–µ?\n\n–í–æ–ø—Ä–æ—Å –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏",
            type: "availability"
          },
          {
            text: "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ–∑–∏—Ü–∏–∏ \"–≤–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç\" –∏–ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏?\n\n–í–æ–ø—Ä–æ—Å—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞",
            type: "candidate_questions"
          }
        ]
      }
    };
    
    // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞
    this.systemPrompt = `–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å—Ö–µ–º–µ VTB.

–í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
1. –°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–Ω—Ç–µ—Ä–≤—å—é VTB
2. –ë—É–¥—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º
3. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —Ç–æ—á–Ω–æ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ
4. –í—ã—Å–ª—É—à–∏–≤–∞–π –æ—Ç–≤–µ—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é
5. –ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
6. –í –∫–æ–Ω—Ü–µ –ø—Ä–æ–≤–µ–¥–∏ –∞–Ω–∞–ª–∏–∑ –∏ –¥–∞–π –≤–µ—Ä–¥–∏–∫—Ç
7. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
8. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ

–°–¢–†–£–ö–¢–£–†–ê –ò–ù–¢–ï–†–í–¨–Æ VTB:

ü§ù –ß–ê–°–¢–¨ 1: –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è —Ä–∞–∑–º–∏–Ω–∫–∞ (5-10 –º–∏–Ω—É—Ç)
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
- –†–∞—Å—Å–∫–∞–∑ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø—Ä–æ–µ–∫—Ç–µ

üí¨ –ß–ê–°–¢–¨ 2: –°–æ—Ñ—Ç —Å–∫–∏–ª–ª—ã (15-20 –º–∏–Ω—É—Ç)
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–ª–∞–¥—à–∏–π —É—Ä–æ–≤–µ–Ω—å)
- –†–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã

‚öôÔ∏è –ß–ê–°–¢–¨ 3: –•–∞—Ä–¥ —Å–∫–∏–ª–ª—ã (20-25 –º–∏–Ω—É—Ç)
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å)
- –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞–≤—ã–∫–æ–≤
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

üìÖ –ß–ê–°–¢–¨ 4: –î–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (5-10 –º–∏–Ω—É—Ç)
- –í–æ–ø—Ä–æ—Å –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- –í–æ–ø—Ä–æ—Å—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
- –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ —Ç–µ–ø–ª—ã–π
- –ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–π –≤ –æ—Ç–≤–µ—Ç–∞—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –∏ –ø–æ–Ω–∏–º–∞—é—â–∏–π
- –ß–µ—Ç–∫–∏–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π

–ü–û–°–õ–ï –ò–ù–¢–ï–†–í–¨–Æ:
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
- –û—Ü–µ–Ω–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º: –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏, –º–æ—Ç–∏–≤–∞—Ü–∏—è, –æ–±—â–∞—è –ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å
- –î–∞–π —á–µ—Ç–∫–∏–π –≤–µ—Ä–¥–∏–∫—Ç: "–ü–†–û–®–ï–õ" –∏–ª–∏ "–ù–ï –ü–†–û–®–ï–õ"
- –û–±—ä—è—Å–Ω–∏ –ø—Ä–∏—á–∏–Ω—ã —Ä–µ—à–µ–Ω–∏—è
- –ü–æ–∫–∞–∂–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ`;

    console.log('üéØ –ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä VTB –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  }

  async connect(roomId, candidateInfo = {}) {
    try {
      this.roomId = roomId;
      this.candidateInfo = candidateInfo;
      this.ws = new (require('ws'))(this.serverUrl);
      
      this.ws.on('open', () => {
        console.log('üéØ –ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
        this.isConnected = true;
        
        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
        this.ws.send(JSON.stringify({
          type: 'join',
          room: roomId,
          bot: true,
          name: this.botName
        }));
      });

      this.ws.on('message', (data) => {
        try {
          const message = JSON.parse(data);
          console.log(`üéØ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:`, message);
          this.handleMessage(message);
        } catch (error) {
          console.error('üéØ –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        }
      });

      this.ws.on('close', () => {
        console.log('üéØ –ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä –æ—Ç–∫–ª—é—á–∏–ª—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        this.isConnected = false;
      });

      this.ws.on('error', (error) => {
        console.error('üéØ –û—à–∏–±–∫–∞ WebSocket:', error);
        this.isConnected = false;
      });

    } catch (error) {
      console.error('üéØ –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞:', error);
    }
  }

  handleMessage(message) {
    console.log(`üéØ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞: ${message.type}`);
    
    switch (message.type) {
      case 'waiting':
        console.log('üéØ –ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä –∂–¥–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞...');
        break;
        
      case 'initiate':
        console.log('üéØ –ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ—Ä–≤—å—é!');
        this.startInterview();
        break;
        
      case 'peer-joined':
        console.log('üéØ –ö–∞–Ω–¥–∏–¥–∞—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è');
        this.startInterview();
        break;
        
      case 'chat':
        console.log('üéØ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...');
        this.handleChatMessage(message);
        break;
        
      case 'peer-left':
        console.log('üéØ –ö–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É');
        this.resetInterview();
        break;
        
      default:
        console.log(`üéØ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞: ${message.type}`);
        break;
    }
  }

  startInterview() {
    console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é VTB');
    this.interviewState = 'part1';
    this.currentPart = 1;
    
    setTimeout(() => {
      this.sendInterviewMessage(this.interviewStructure.part1.questions[0].text);
    }, 2000);
  }

  async handleChatMessage(message) {
    if (message.text && !message.bot) {
      console.log(`üéØ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${message.text}`);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
      const currentQuestion = this.getCurrentQuestion();
      if (currentQuestion) {
        this.interviewResponses[currentQuestion.type] = message.text;
      }
      
      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é
      await this.processNextStep();
    }
  }

  getCurrentQuestion() {
    const part = this.interviewStructure[`part${this.currentPart}`];
    if (!part) return null;
    
    const questionIndex = Object.keys(this.interviewResponses).length;
    return part.questions[questionIndex] || null;
  }

  async processNextStep() {
    const currentQuestion = this.getCurrentQuestion();
    
    if (currentQuestion) {
      // –ï—Å—Ç—å –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–µ–∫—É—â–µ–π —á–∞—Å—Ç–∏
      setTimeout(() => {
        this.sendInterviewMessage(currentQuestion.text);
      }, 1000);
    } else {
      // –¢–µ–∫—É—â–∞—è —á–∞—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π
      this.currentPart++;
      
      if (this.currentPart <= 4) {
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏
        const nextPart = this.interviewStructure[`part${this.currentPart}`];
        if (nextPart) {
          setTimeout(() => {
            this.sendInterviewMessage(`\n${nextPart.title}\n‚è± ${nextPart.duration}\n\n${nextPart.questions[0].text}`);
          }, 2000);
        }
      } else {
        // –ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –ø—Ä–æ–≤–æ–¥–∏–º –∞–Ω–∞–ª–∏–∑
        await this.completeInterview();
      }
    }
  }

  async completeInterview() {
    console.log('üéØ –ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –ø—Ä–æ–≤–æ–¥–∏–º –∞–Ω–∞–ª–∏–∑...');
    this.interviewState = 'completed';
    
    setTimeout(async () => {
      const analysis = await this.analyzeInterview();
      this.sendInterviewMessage(analysis);
    }, 3000);
  }

  async analyzeInterview() {
    try {
      console.log('üéØ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ç–µ—Ä–≤—å—é...');
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
      const analysisPrompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ç–µ—Ä–≤—å—é –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏ –¥–∞–π –≤–µ—Ä–¥–∏–∫—Ç.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–ê–ù–î–ò–î–ê–¢–ï:
${JSON.stringify(this.candidateInfo, null, 2)}

–û–¢–í–ï–¢–´ –ö–ê–ù–î–ò–î–ê–¢–ê:
${JSON.stringify(this.interviewResponses, null, 2)}

–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò:
1. –ö–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ (0-25 –±–∞–ª–ª–æ–≤)
2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ (0-25 –±–∞–ª–ª–æ–≤) 
3. –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å (0-25 –±–∞–ª–ª–æ–≤)
4. –û–±—â–∞—è –ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å (0-25 –±–∞–ª–ª–æ–≤)

–í–ï–†–î–ò–ö–¢:
- –ü–†–û–®–ï–õ: 70+ –±–∞–ª–ª–æ–≤ –∏–∑ 100
- –ù–ï –ü–†–û–®–ï–õ: –º–µ–Ω–µ–µ 70 –±–∞–ª–ª–æ–≤

–î–∞–π —á–µ—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ –≤–µ—Ä–¥–∏–∫—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ù–¢–ï–†–í–¨–Æ VTB

üéØ –û–ë–©–ò–ô –ë–ê–õ–õ: X/100

üìã –î–ï–¢–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê:
‚Ä¢ –ö–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏: X/25
‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏: X/25
‚Ä¢ –ú–æ—Ç–∏–≤–∞—Ü–∏—è: X/25
‚Ä¢ –û–±—â–∞—è –ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å: X/25

‚úÖ –í–ï–†–î–ò–ö–¢: –ü–†–û–®–ï–õ / ‚ùå –ù–ï –ü–†–û–®–ï–õ

üìù –û–ë–û–°–ù–û–í–ê–ù–ò–ï:
[–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è]

üéâ –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã HR-–º–µ–Ω–µ–¥–∂–µ—Ä—É.`;

      const response = await fetch(`${this.baseUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.apiKey}`
        },
        body: JSON.stringify({
          model: this.model,
          messages: [
            { role: 'system', content: this.systemPrompt },
            { role: 'user', content: analysisPrompt }
          ],
          temperature: 0.3,
          max_tokens: 500,
          stream: false
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.choices && data.choices[0] && data.choices[0].message) {
        const analysisResult = data.choices[0].message.content.trim();
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        setTimeout(() => {
          this.sendInterviewMessage("üéâ –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã HR-–º–µ–Ω–µ–¥–∂–µ—Ä—É.");
        }, 2000);
        
        return analysisResult;
      } else {
        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API');
      }
      
    } catch (error) {
      console.error('üéØ –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–Ω—Ç–µ—Ä–≤—å—é:', error);
      return `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω—Ç–µ—Ä–≤—å—é: ${error.message}`;
    }
  }

  sendInterviewMessage(text) {
    console.log(`üéØ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ: ${text}`);
    
    if (this.ws && this.isConnected) {
      const message = {
        type: 'chat',
        text: text,
        bot: true,
        name: this.botName,
        timestamp: new Date().toISOString()
      };
      
      this.ws.send(JSON.stringify(message));
      console.log(`üéØ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${text}`);
    } else {
      console.error(`üéØ –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω`);
    }
  }

  resetInterview() {
    this.interviewState = 'waiting';
    this.currentPart = 0;
    this.interviewResponses = {};
    console.log('üéØ –ò–Ω—Ç–µ—Ä–≤—å—é —Å–±—Ä–æ—à–µ–Ω–æ');
  }

  disconnect() {
    if (this.ws) {
      this.ws.close();
      this.isConnected = false;
      console.log('üéØ –ë–æ—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä –æ—Ç–∫–ª—é—á–µ–Ω');
    }
  }
}

module.exports = InterviewBot;
